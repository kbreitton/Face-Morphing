%% INITIALIZE
do_trig = 1;
im1 = (imread('marilyn-monroe.jpg'));
im2 = imread('barbie.jpg');

%rescale images to same image size
sizes(1) = sqrt(size(im1, 1) * size(im1, 2));
sizes(2) = sqrt(size(im2, 1) * size(im2, 2));

[mini index] = min(sizes);

if index == 1
im2 = imresize(im2, [size(im1,1) size(im1,2)]);
else
    im1 = imresize(im1, [size(im2,1) size(im2,2)]);
end

% Control points
im1_pts = [181.698541329011,251.510534846029;246.233387358185,252.260940032415;219.969205834684,249.259319286872;216.750000000000,239.750000000000;215.750000000000,264.250000000000;304.014586709887,256.763371150729;370.050243111832,250.760129659643;332.529983792545,250.009724473258;335.750000000000,264.250000000000;334.750000000000,240.250000000000;275.499189627229,246.257698541329;277.000000000000,303.288492706645;249.985413290114,316.045380875203;303.264181523501,318.296596434360;246.233387358185,218.492706645057;305.515397082658,218.492706645057;195.205834683955,202.734197730956;161.437601296596,201.983792544571;358.043760129660,204.235008103728;389.560777957861,201.233387358185;273.247974068071,136.698541329011;350.539708265802,120.189627228525;200.458670988655,118.688816855754;278.500810372772,344.560777957861;262.742301458671,341.559157212318;291.257698541329,340.808752025932;231.975688816856,358.068071312804;320.523500810373,360.319286871961;298.011345218801,379.079416531605;277.750405186386,379.829821717990;252.236628849271,378.329011345219;277.000000000000,360.319286871961;277.000000000000,438.361426256078;183.199351701783,369.324149108590;372.301458670989,378.329011345219;210.964343598055,411.346839546191;162.188006482982,285.278768233387;382.807131280389,289.781199351702;1.28993055555557,2.91145833333331;553.500000000000,0.500000000000000;0.500000000000000,463.500000000000;553.500000000000,463.500000000000;134.723958333333,250.487847222222;160.446180555556,332.477430555556;408.022569444444,272.994791666667;390.338541666667,334.085069444444;144.369791666667,298.717013888889];
im2_pts = [102.905996758509,122.440842787682;233.476499189627,169.716369529984;186.951377633711,141.200972447326;183,116;180.948136142626,169.716369529984;321.273905996758,171.217179902755;446.591572123177,126.192868719611;373.051863857374,145.703403565640;381,172;377,121.000000000000;274.748784440843,153.207455429498;275.499189627229,253.761750405186;236.478119935170,268.769854132901;310.768233387358,272.521880064830;228.974068071313,93.1750405186386;325.025931928687,96.9270664505673;135.173419773096,53.4035656401945;97.6531604538087,48.9011345218801;421.077795786062,55.6547811993518;458.598055105349,49.6515397082658;278.500810372771,1.62560777957867;392.562398703404,1.62560777957867;153.183144246353,2.37601296596444;274.748784440843,319.047001620746;248.484602917342,307.790923824959;297.260940032415,307.790923824959;195.205834683955,317.546191247974;349.789303079417,317.546191247974;315.270664505673,365.572123176661;277,379.829821717990;235.727714748784,369.324149108590;276.249594813614,343.059967585089;278.500810372771,454.119935170178;146.429497568882,372.325769854133;397.815235008104,382.081037277147;198.207455429498,426.354943273906;94.6515397082658,189.226904376013;453.345218800648,195.980551053485;0.500000000000000,0.500000000000000;553.500000000000,0.500000000000000;0.500000000000000,463.500000000000;553.500000000000,463.500000000000;75.2413194444441,152.421875000000;88.1024305555552,231.196180555556;464.289930555555,160.460069444444;464.289930555555,248.880208333333;73.6336805555552,192.612847222222];
average = (im1_pts + im2_pts) .* 05;

%calculate delaunay triangulation
tri = delaunay(average(:,1), average(:,2));;

% Figure 
h = figure(2); clf;
whitebg(h,[0 0 0]);


%% EVAL
if do_trig
    fname = 'Project2_klydeb_trig.avi';
else
    fname = 'Project2_klydeb_tps.avi';
end
try
    % VideoWriter based video creation
    h_avi = VideoWriter(fname, 'Uncompressed AVI');
    h_avi.FrameRate = 10;
    h_avi.open();
catch
    % Fallback deprecated avifile based video creation
    h_avi = avifile(fname,'fps',10);
end

% Warp reference images
% if (do_trig)
%   img_ref(1) = {morph(img, img, p1, cell2mat(p2(1)), tri, 1, 0)};
%   img_ref(2) = {morph(img, img, p1, cell2mat(p2(2)), tri, 1, 0)};
%   img_ref(3) = {morph(img, img, p1, cell2mat(p2(3)), tri, 1, 0)};
%   img_ref(4) = {morph(img, img, p1, cell2mat(p2(4)), tri, 1, 0)};
%   img_ref(5) = {cell2mat(img_ref(1))};
% else
%   img_ref(1) = {morph_tps_wrapper(img, img, p1, cell2mat(p2(1)), 1, 0)};
%   img_ref(2) = {morph_tps_wrapper(img, img, p1, cell2mat(p2(2)), 1, 0)};
%   img_ref(3) = {morph_tps_wrapper(img, img, p1, cell2mat(p2(3)), 1, 0)};
%   img_ref(4) = {morph_tps_wrapper(img, img, p1, cell2mat(p2(4)), 1, 0)};
%   img_ref(5) = {cell2mat(img_ref(1))};
% end  

% Morph iteration
% for j=1:4
  for w=0:0.0167:1
    if (do_trig == 0)
      img_morphed = morph_tps_wrapper(im1, im2, im1_pts, im2_pts, w, w);
    else
      img_morphed = morph(im1, im2, im1_pts, im2_pts, tri, w, w);
    end
    % if image type is double, modify the following line accordingly if necessary
    imagesc(img_morphed);
    axis image; axis off;drawnow;
    try
        % VideoWriter based video creation
        h_avi.writeVideo(getframe(gcf));
    catch
        % Fallback deprecated avifile based video creation
        h_avi = addframe(h_avi, getframe(gcf));
    end
  end
% end
try
    % VideoWriter based video creation
    h_avi.close();
catch
    % Fallback deprecated avifile based video creation
    h_avi = close(h_avi);
end
clear h_avi;
